(()=>{"use strict";const e=document.getElementById("root");new class{constructor(e){this.container=e,this.messageInput=document.querySelector(".chat__messages-input"),this.chat=document.querySelector(".chat__messages-container"),this.ws=new WebSocket("wss://ahj-homeworks-sse-ws-server.onrender.com/ws"),this.chatUserlist=document.querySelector(".chat__userlist"),this.myUserName="",this.inactiveTimeout=3e5,this.userActivityMap=new Map}async init(){const e=localStorage.getItem("myUserName");e&&(this.myUserName=e),this.subscribeOnEvents(),this.closeSession(),setInterval(this.checkInactiveUsers,1e4)}checkInactiveUsers(){const e=Date.now();this.userActivityMap.forEach(((s,t)=>{e-s>this.inactiveTimeout&&(this.userActivityMap.delete(t),this.removeUserFromList(t))}))}subscribeOnEvents(){const e=document.querySelector(".modal__input");document.querySelector(".chat__connect").addEventListener("click",(()=>{const s=e.value;s&&fetch("https://ahj-homeworks-sse-ws-server.onrender.com/new-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s})}).then((e=>e.ok?e.json():e.json().then((e=>{alert(e.message)})))).then((e=>{"ok"===e.status?(this.myUserName=s,localStorage.setItem("myUserName",s),this.addUserToList(e.user),document.querySelector(".modal__background").classList.add("hidden")):alert(e.message)}))})),this.ws.addEventListener("error",(e=>{console.log(e),console.log("ws error")})),this.ws.addEventListener("open",(e=>{if(console.log(e),localStorage.getItem("myUserName")){const e={type:"new-user",user:{name:localStorage.getItem("myUserName")}};this.ws.send(JSON.stringify(e))}console.log("ws open")})),this.ws.addEventListener("close",(e=>{console.log(e),console.log("ws close")})),this.ws.addEventListener("message",(e=>{console.log(e);const s=JSON.parse(e.data);console.log("data: ",s),Array.isArray(s)?(this.chatUserlist.innerHTML="",s.forEach((e=>this.addUserToList(e)))):"send"===s.type&&this.renderMessages(s),console.log("ws message")})),this.messageInput.onkeypress=e=>{"Enter"===e.key&&this.onEnterChatHandler()}}addUserToList(e){const s=document.createElement("div");s.className="chat__user",s.textContent=e.name,s.dataset.id=e.id,this.chatUserlist.appendChild(s)}removeUserFromList(e){document.querySelectorAll(".chat__user").forEach((s=>{if(s.textContent===e){if(console.log("завершилось время ожидания активности"),s.remove(),this.myUserName){const e={type:"exit",user:{name:this.myUserName}};this.ws.send(JSON.stringify(e))}console.log("Session closed! Please restart the website."),alert("Session closed! Please restart the website."),localStorage.removeItem("myUserName"),document.querySelector(".modal__background").classList.remove("hidden")}}))}onEnterChatHandler(){const e=this.messageInput.value;e&&(this.sendMessage(e),this.messageInput.value="")}async sendMessage(e){try{const s={type:"send",message:e,user:{name:this.myUserName}};this.ws.send(JSON.stringify(s))}catch(e){console.error(`Ошибка при отправке сообщения: ${e}`)}}renderMessages(e){const s=document.createElement("div");if(this.myUserName===e.user.name){s.className="message__container-y";const t=document.createElement("div");t.className="message__header-y",t.textContent=this.myUserName;const n=document.createElement("div");n.className="message__container-yourself",n.textContent=e.message,s.appendChild(t),s.appendChild(n),this.userActivityMap.set(this.myUserName,Date.now())}else{s.className="message__container-i";const t=document.createElement("div");t.className="message__header-i",t.textContent=e.user.name;const n=document.createElement("div");n.className="message__container-interlocutor",n.textContent=e.message,s.appendChild(t),s.appendChild(n),this.userActivityMap.set(e.user.name,Date.now())}this.chat.appendChild(s)}closeSession(){window.addEventListener("beforeunload",(()=>{if(console.log("закрылась вкладка или окно браузера"),this.myUserName){const e={type:"exit",user:{name:this.myUserName}};this.ws.send(JSON.stringify(e))}console.log("Session closed! Please restart the website."),alert("Session closed! Please restart the website."),localStorage.removeItem("myUserName"),document.querySelector(".modal__background").classList.remove("hidden")}))}}(e).init()})();